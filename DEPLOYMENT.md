# üöÄ Deployment Guide

This guide covers deploying the EPC Project Management System to various platforms.

## üìã Table of Contents

1. [Prerequisites](#prerequisites)
2. [Environment Variables](#environment-variables)
3. [Frontend Deployment (Vercel)](#frontend-deployment-vercel)
4. [Backend Deployment (Railway/Render)](#backend-deployment-railway)
5. [Database Setup (Supabase/Railway)](#database-setup)
6. [Full Stack Deployment](#full-stack-deployment)
7. [Post-Deployment](#post-deployment)

---

## üîß Prerequisites

- GitHub account
- Deployment platform accounts (Vercel, Railway, or Render)
- Database hosting (Supabase, Railway, or Neon)
- Environment variables ready

---

## üåç Environment Variables

### Backend (.env)

```bash
# Database
DATABASE_URL=postgresql://user:password@host:5432/database

# Redis (optional for caching)
REDIS_URL=redis://host:6379

# JWT
JWT_SECRET=your-super-secret-jwt-key-min-32-chars

# Server
PORT=3001
NODE_ENV=production

# CORS (Frontend URL)
FRONTEND_URL=https://your-frontend.vercel.app
```

### Frontend (.env.local)

```bash
# Backend API
NEXT_PUBLIC_API_URL=https://your-backend.railway.app

# NextAuth
NEXTAUTH_URL=https://your-frontend.vercel.app
NEXTAUTH_SECRET=your-nextauth-secret-min-32-chars
```

---

## üé® Frontend Deployment (Vercel)

### Option 1: Via Vercel Dashboard

1. **Go to [Vercel](https://vercel.com)**
2. **Click "Add New Project"**
3. **Import your GitHub repository**
4. **Configure Project:**
   - Framework Preset: `Next.js`
   - Root Directory: `frontend`
   - Build Command: `npm run build`
   - Output Directory: `.next`
   - Install Command: `npm install`

5. **Add Environment Variables:**
   ```
   NEXT_PUBLIC_API_URL=https://your-backend-url.railway.app
   NEXTAUTH_URL=https://your-project.vercel.app
   NEXTAUTH_SECRET=your-secret-here
   ```

6. **Deploy!**

### Option 2: Via Vercel CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Deploy from frontend directory
cd frontend
vercel

# Follow prompts
# Set environment variables when asked
```

### Build Settings for Vercel

Create `vercel.json` in project root:

```json
{
  "version": 2,
  "builds": [
    {
      "src": "frontend/package.json",
      "use": "@vercel/next"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "frontend/$1"
    }
  ]
}
```

---

## üöÇ Backend Deployment (Railway)

### Step 1: Create Railway Account

1. Go to [Railway.app](https://railway.app)
2. Sign up with GitHub

### Step 2: Create New Project

1. Click "New Project"
2. Select "Deploy from GitHub repo"
3. Choose your `epc-pm` repository

### Step 3: Configure Backend Service

1. **Root Directory:** `backend`
2. **Build Command:** `npm install && npm run build`
3. **Start Command:** `npm run start:prod`

### Step 4: Add PostgreSQL Database

1. Click "New" ‚Üí "Database" ‚Üí "PostgreSQL"
2. Railway will automatically create `DATABASE_URL`
3. Copy the connection string

### Step 5: Add Environment Variables

```bash
DATABASE_URL=<auto-generated-by-railway>
JWT_SECRET=your-jwt-secret-min-32-chars
PORT=3001
NODE_ENV=production
FRONTEND_URL=https://your-frontend.vercel.app
```

### Step 6: Run Migrations

In Railway dashboard:
1. Go to your backend service
2. Click "Settings" ‚Üí "Deploy"
3. Add custom start command:
   ```bash
   npx prisma migrate deploy && npm run start:prod
   ```

Or use Railway CLI:
```bash
railway run npx prisma migrate deploy
```

### Step 7: Seed Database (Optional)

```bash
railway run npm run prisma:seed
```

---

## üê≥ Alternative: Backend Deployment (Render)

### Step 1: Create Render Account

1. Go to [Render.com](https://render.com)
2. Sign up with GitHub

### Step 2: Create PostgreSQL Database

1. Click "New" ‚Üí "PostgreSQL"
2. Name: `epc-database`
3. Copy the **Internal Database URL**

### Step 3: Create Web Service

1. Click "New" ‚Üí "Web Service"
2. Connect your GitHub repository
3. Configure:
   - **Name:** `epc-backend`
   - **Root Directory:** `backend`
   - **Environment:** `Node`
   - **Build Command:** `npm install && npx prisma generate && npm run build`
   - **Start Command:** `npx prisma migrate deploy && npm run start:prod`

### Step 4: Add Environment Variables

```bash
DATABASE_URL=<from-render-postgres>
JWT_SECRET=your-jwt-secret
PORT=3001
NODE_ENV=production
FRONTEND_URL=https://your-frontend.vercel.app
```

---

## üóÑÔ∏è Database Setup (Supabase)

### Option: Use Supabase PostgreSQL

1. **Create Supabase Project**
   - Go to [Supabase](https://supabase.com)
   - Create new project
   - Wait for database to initialize

2. **Get Connection String**
   - Go to Project Settings ‚Üí Database
   - Copy "Connection string" (Transaction mode)
   - Replace `[YOUR-PASSWORD]` with your database password

3. **Update DATABASE_URL**
   ```bash
   DATABASE_URL=postgresql://postgres:[YOUR-PASSWORD]@db.xxx.supabase.co:5432/postgres
   ```

4. **Run Migrations**
   ```bash
   # From your local machine
   cd backend
   npx prisma migrate deploy
   npx prisma db seed
   ```

---

## üîÑ Full Stack Deployment Workflow

### 1. **Setup Database First**
   - Create PostgreSQL database (Railway/Render/Supabase)
   - Copy connection string

### 2. **Deploy Backend**
   - Deploy to Railway/Render
   - Add environment variables
   - Run migrations
   - Test API endpoint: `https://your-backend.railway.app/api`

### 3. **Deploy Frontend**
   - Deploy to Vercel
   - Add backend URL to environment variables
   - Test login: `https://your-frontend.vercel.app/login`

### 4. **Connect Frontend to Backend**
   - Update `NEXT_PUBLIC_API_URL` in Vercel
   - Update `FRONTEND_URL` in Railway (for CORS)
   - Redeploy both if needed

---

## ‚úÖ Post-Deployment Checklist

- [ ] Backend API is accessible
- [ ] Database migrations ran successfully
- [ ] Frontend loads without errors
- [ ] Login works with seeded credentials
- [ ] API calls from frontend work
- [ ] CORS is configured correctly
- [ ] Environment variables are set
- [ ] SSL/HTTPS is enabled
- [ ] Error tracking is set up (optional)
- [ ] Monitoring is configured (optional)

---

## üß™ Testing Deployment

### Test Backend

```bash
# Health check
curl https://your-backend.railway.app/api

# API documentation
https://your-backend.railway.app/api/docs

# Login test
curl -X POST https://your-backend.railway.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@epc.com","password":"admin123"}'
```

### Test Frontend

1. Visit `https://your-frontend.vercel.app`
2. Try logging in with:
   - Email: `admin@epc.com`
   - Password: `admin123`
3. Check browser console for errors
4. Test creating a new project

---

## üêõ Troubleshooting

### Build Fails: "Prisma Client not generated"

**Solution:** Add `prebuild` script in `backend/package.json`:
```json
"scripts": {
  "prebuild": "prisma generate",
  "build": "nest build"
}
```

### CORS Errors

**Solution:** Update backend CORS configuration in `main.ts`:
```typescript
app.enableCors({
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true,
});
```

### Database Connection Fails

**Solutions:**
1. Check `DATABASE_URL` format
2. Ensure database is running
3. Check firewall/network settings
4. Verify SSL mode if required

### Frontend Can't Connect to Backend

**Solutions:**
1. Verify `NEXT_PUBLIC_API_URL` is correct
2. Check backend is running
3. Test backend URL directly in browser
4. Check CORS settings

---

## üìä Monitoring & Logs

### Vercel Logs
```bash
vercel logs <deployment-url>
```

### Railway Logs
- Go to Railway dashboard
- Click on your service
- View "Deployments" tab
- Click on latest deployment

### Render Logs
- Go to Render dashboard
- Click on your service
- View "Logs" tab

---

## üîê Security Recommendations

1. **Use strong secrets** (minimum 32 characters)
2. **Enable SSL/HTTPS** (automatic on Vercel/Railway/Render)
3. **Set up rate limiting** in production
4. **Use environment-specific configs**
5. **Enable database backups**
6. **Set up error tracking** (Sentry)
7. **Monitor API usage**
8. **Regular security updates**

---

## üìû Support

For deployment issues:
1. Check platform documentation
2. Review error logs
3. Check GitHub issues
4. Contact platform support

---

**Last Updated:** 2025-12-29
